version: "3.9"
services:
  client:
    env_file:
      - git-info.env
      - run-parameters.env
    environment:
      # this generates nice graphs in grafana
      - PYROSCOPE_STATSD_ADDR=grafana:8125

    build:
      context: ../
      dockerfile: benchmark/Dockerfile

  pyroscope:
    environment:
      - PYROSCOPE_STATSD_ADDR=grafana:8125
      - PYROSCOPE_LOG_LEVEL=debug
      - PYROSCOPE_CACHE_TREE_SIZE=10
    build:
      context: ../
      dockerfile: Dockerfile
    command:
      - server
    ports:
      - 4040:4040
    deploy:
      resources:
        limits:
          cpus: 1
          memory: 512M

  grafana:
    platform: linux/amd64
    build:
      context: grafana-docker
    volumes:
      - ./grafana-dashboards:/src/dashboards
    ports:
      - 8125:8125/udp
      - 8080:80
