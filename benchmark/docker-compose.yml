version: "3.9"
services:
  client:
    env_file:
      - git-info.env
    environment:
      # these parameters set generated profiles parameters
      - RAND_SEED=23061912
      - PROFILE_NODES=10
      - PROFILE_DEPTH=10
      - PROFILE_SYMBOL_LENGTH=10

      # these parameters set how many clients we should emulate
      - CLIENTS=10
      - REQUESTS=1
      # this generates nice graphs in grafana
      - PYROSCOPE_STATSD_ADDR=grafana:8125

    build:
      context: ../
      dockerfile: benchmark/Dockerfile
  pyroscope:
    environment:
      - PYROSCOPE_STATSD_ADDR=grafana:8125
      - PYROSCOPE_LOG_LEVEL=debug
    build:
      context: ../
      dockerfile: Dockerfile
    command:
      - server
    ports:
      - 4040:4040
    deploy:
      resources:
        limits:
          cpus: 1
          memory: 512M

  grafana:
    platform: linux/amd64
    build:
      context: grafana-docker
    volumes:
      - ./grafana-dashboards:/src/dashboards
    ports:
      - 8125:8125/udp
      - 8080:80
